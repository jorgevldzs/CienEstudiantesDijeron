@page "/"
@using CienEstudiantesDijeron.Data
@using CienEstudiantesDijeron.Models
@inject JuegoService Juego
@inject ApplicationDbContext DbContext
@rendermode InteractiveServer
@implements IDisposable
@inject IJSRuntime JSRuntime

<PageTitle>Control</PageTitle>

<h3>Panel de Control</h3>

<button @onclick="AbrirVentana" class="btn btn-secondary">Abrir Tablero</button>

<hr />

@* --- SECCIÓN DE CONFIGURACIÓN --- *@
@* Se deshabilita o oculta cuando la partida inicia *@
<div style="margin-bottom: 20px; display: @(partidaEnCurso ? "none" : "block")">
    <h4>Configuración de Partida</h4>
    <label>Nombre Equipo 1:</label><br>
    <input @bind="nombreTmp1" placeholder="Nombre Equipo 1" /><br>

    <label>Nombre Equipo 2:</label><br>
    <input @bind="nombreTmp2" placeholder="Nombre Equipo 2" /><br />

    <label>Número de Rondas:</label><br>
    <input @bind="cantidadRondas" type="number" min="1" /><br><br>

    <button @onclick="ComenzarPartida" class="btn btn-primary">Comenzar Partida</button>
</div>

@* --- SECCIÓN DEL CONTENIDO DE LA PARTIDA --- *@
@if (partidaEnCurso)
{
    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 10px;">
        @if (Juego.PartidaTerminada) 
        {
            <div style="text-align: center; padding: 30px; background: #f8f9fa; border: 2px dashed #28a745; border-radius: 10px;">
                <h2 class="text-success">¡PARTIDA FINALIZADA!</h2>
                <hr />
                
                <div style="margin: 20px auto; max-width: 400px;">
                    <table class="table table-bordered" style="background: white;">
                        <thead class="thead-dark">
                            <tr>
                                <th>Equipo</th>
                                <th>Puntaje Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="@(Juego.puntosEquipo1 >= Juego.puntosEquipo2 ? "font-weight: bold; background: #d4edda;" : "")">
                                <td>@Juego.Equipo1</td>
                                <td>@Juego.puntosEquipo1 pts</td>
                            </tr>
                            <tr style="@(Juego.puntosEquipo2 >= Juego.puntosEquipo1 ? "font-weight: bold; background: #d4edda;" : "")">
                                <td>@Juego.Equipo2</td>
                                <td>@Juego.puntosEquipo2 pts</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top: 15px; padding: 10px; border: 1px solid #28a745;">
                        <strong>GANADOR: </strong> 
                        <span class="badge bg-success" style="font-size: 1.2rem;">
                            @(Juego.puntosEquipo1 > Juego.puntosEquipo2 ? Juego.Equipo1 : (Juego.puntosEquipo2 > Juego.puntosEquipo1 ? Juego.Equipo2 : "EMPATE"))
                        </span>
                    </div>
                </div>

                <hr />
                <div style="margin-top: 20px;">
                    <h5>Historial de Puntos por Ronda</h5>
                    <table class="table table-sm table-striped" style="font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th>Ronda</th>
                                <th>Equipo</th>
                                <th>Puntos</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!Juego.HistorialPuntos.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No hay puntos asignados aún</td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var registro in Juego.HistorialPuntos)
                                {
                                    <tr>
                                        <td>@registro.Ronda</td>
                                        <td>@registro.Equipo</td>
                                        <td>+@registro.Puntos</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <button @onclick="ResetearParaNuevaPartida" class="btn btn-primary btn-lg" style="margin-top: 20px;">
                    ← VOLVER AL INICIO (NUEVA PARTIDA)
                </button>
            </div>
        }
        else
        {
                    <div style="display: flex; justify-content: space-between;">
            <h4>Ronda Actual: @rondaActual / @cantidadRondas</h4>
            <button @onclick="FinalizarPartida" class="btn btn-danger">Finalizar Partida</button>
        </div>
        <div>
            <h5>Puntos Ronda: @Juego.puntosPartida</h5>
            <br>
            <h5>Puntos @Juego.Equipo1: @Juego.puntosEquipo1</h5>
            <h5>Puntos @Juego.Equipo2: @Juego.puntosEquipo2</h5>
        </div>

        <hr />

        @if (string.IsNullOrEmpty(Juego.PreguntaActual))
        {
            <button @onclick="CargarPreguntaAleatoria" class="btn btn-primary btn-lg">Generar Pregunta</button>
        }
        else
        {
            @* BLOQUE DE MULTIPLICADOR (Arriba de la pregunta) *@
            <div style="margin-bottom: 15px; padding: 10px; background: @(Juego.PreguntaRevelada ? "#e9ecef" : "#fff3cd"); border-radius: 5px;">
                <span style="font-weight: bold;">Multiplicador de esta Ronda:</span>
                <div class="btn-group ms-3">
                    @foreach (var m in new int[] { 1, 2, 3 })
                    {
                        <button @onclick="() => Juego.SetMultiplicador(m)" 
                                disabled="@Juego.PreguntaRevelada"
                                class="btn @(Juego.Multiplicador == m ? "btn-dark" : "btn-outline-dark")">
                            x @m
                        </button>
                    }
                </div>
                @if (Juego.PreguntaRevelada)
                {
                    <small class="text-muted ms-2">(Ronda en curso)</small>
                }
            </div>

            <div style="background: #f0f0f0; padding: 15px; border-radius: 5px;">
                <h5><strong>Vista del Admin:</strong> @Juego.PreguntaActual</h5>
                
                @if (!Juego.PreguntaRevelada)
                {
                    <button @onclick="() => Juego.RevelarPregunta()" class="btn btn-warning w-100">
                        REVELAR PREGUNTA AL TABLERO
                    </button>
                }
                else
                {
                    <span class="badge bg-success">Pregunta visible en tablero</span>
                }
            </div>

            
            @if (Juego.PreguntaRevelada) {
                <h4 style="margin-top:20px;">Respuestas (Presiona para revelar)</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    @foreach (var respuesta in Juego.RespuestasActuales)
                    {
                        <button @onclick="() => Juego.RevelarRespuestaPorTexto(respuesta.res_respuesta)"
                        style="padding: 10px; background: @(Juego.RespuestasReveladas.Contains(respuesta.res_respuesta) ? "#4CAF50" : "#2196F3"); color: white; border: none; border-radius: 5px; text-align: left;">
                
                            @* Nombre de la respuesta *@
                            <strong>@respuesta.res_respuesta</strong> 
                            
                            <span style="float: right;">
                                @* Valor base *@
                                (@respuesta.res_cantidad pts)
                                
                                @* Valor multiplicado (solo si el multiplicador es mayor a 1) *@
                                @if (Juego.Multiplicador > 1)
                                {
                                    <span style="margin-left: 10px; color: #ffff00; font-weight: bold;">
                                        ➔ @Juego.ObtenerPuntosMultiplicados(respuesta.res_cantidad) pts
                                    </span>
                                }
                            </span>
                        </button>
                    }
                </div>

                <div style="display: flex; justify-content: space-evenly; margin-top: 20px; background: #eee; padding: 15px;">
                    @* El botón se deshabilita si ya se asignaron puntos O si no hay puntos que asignar *@
                    <button class="btn btn-success" 
                            @onclick="() => Juego.AsignarPuntosEquipo(Juego.Equipo1, rondaActual)"
                            disabled="@(Juego.puntosAsignadosEnRonda || Juego.puntosPartida == 0)">
                        Entregar @Juego.puntosPartida pts a @Juego.Equipo1
                    </button>

                    <button class="btn btn-success" 
                            @onclick="() => Juego.AsignarPuntosEquipo(Juego.Equipo2, rondaActual)"
                            disabled="@(Juego.puntosAsignadosEnRonda || Juego.puntosPartida == 0)">
                        Entregar @Juego.puntosPartida pts a @Juego.Equipo2
                    </button>
                </div>

                @if (Juego.puntosAsignadosEnRonda)
                {
                    <p style="color: green; text-align: center; margin-top: 5px;">
                        ✔ Puntos de la ronda asignados correctamente.
                    </p>
                }
            }


            <button @onclick="SiguienteRonda" style="margin-top: 20px;" class="btn btn-success">
                @(rondaActual < cantidadRondas ? "Siguiente Ronda" : "FINALIZAR Y VER GANADOR")
            </button>
        }

        }
    
    </div>
}

@code {
    private string nombreTmp1 = "";
    private string nombreTmp2 = "";
    private int cantidadRondas = 3; // Valor por defecto
    private int rondaActual = 0;
    private bool partidaEnCurso = false; // Controla la visibilidad
    private List<int> preguntasUsadas = new List<int>();

    protected override void OnInitialized()
    {
        Juego.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        Juego.OnChange -= StateHasChanged;
    }

    private void ComenzarPartida()
    {
        if (string.IsNullOrWhiteSpace(nombreTmp1) || string.IsNullOrWhiteSpace(nombreTmp2) || cantidadRondas <= 0)
        {
            // Podrías agregar una alerta aquí
            return;
        }

        Juego.ActualizarNombres(nombreTmp1, nombreTmp2);
        partidaEnCurso = true;
        rondaActual = 1;
        // Limpiar juego previo si existía
        Juego.LimpiarPregunta(); 
    }

    private void SiguienteRonda()
    {
        if (rondaActual < cantidadRondas)
        {
            rondaActual++;
            Juego.LimpiarPregunta();
        }
        else
        {
            // En lugar de resetear todo, anunciamos el fin para ver resultados
            Juego.FinalizarPartida();
        }
    }

    private void ResetearParaNuevaPartida()
    {
        partidaEnCurso = false;
        rondaActual = 0;
        preguntasUsadas.Clear();
        nombreTmp1 = "";
        nombreTmp2 = "";
        Juego.ReiniciarTodo();
    }

    private void FinalizarPartida()
    {
        partidaEnCurso = false;
        rondaActual = 0;
        preguntasUsadas.Clear();
        Juego.LimpiarPregunta();
        // Opcional: Resetear nombres
        nombreTmp1 = "";
        nombreTmp2 = "";
        Juego.ActualizarNombres(nombreTmp1, nombreTmp2);

    }

    private void CargarPreguntaAleatoria()
    {
        var preguntasDisponibles = DbContext.Preguntas
            .Where(p => !preguntasUsadas.Contains(p.pr_id))
            .ToList();

        if (!preguntasDisponibles.Any())
        {
            preguntasUsadas.Clear();
            preguntasDisponibles = DbContext.Preguntas.ToList();
        }

        if (preguntasDisponibles.Any())
        {
            var random = new Random();
            var preguntaAleatoria = preguntasDisponibles[random.Next(preguntasDisponibles.Count)];
            var respuestas = DbContext.Respuestas.Where(r => r.pr_id == preguntaAleatoria.pr_id).ToList();
            
            preguntasUsadas.Add(preguntaAleatoria.pr_id);
            Juego.ActualizarJuego(preguntaAleatoria.pr_pregunta, preguntaAleatoria.pr_id, respuestas);
        }
    }

    //private async Task AbrirVentana() => await JSRuntime.InvokeVoidAsync("open", "/tablero", "_blank");
    private async Task AbrirVentana()
    {
        // Pasamos la URL, el título y las dimensiones (800x600)
        await JSRuntime.InvokeVoidAsync("openWindow", "/tablero", "Nueva Ventana", 800, 600);
    }
}