@page "/"
@using CienEstudiantesDijeron.Data
@using CienEstudiantesDijeron.Models
@inject JuegoService Juego
@inject ApplicationDbContext DbContext
@rendermode InteractiveServer
@implements IDisposable
@inject IJSRuntime JSRuntime

<PageTitle>Control</PageTitle>

<h3>Panel de Control</h3>

<button @onclick="AbrirVentana" class="btn btn-secondary">Abrir Tablero</button>

<hr />

@* --- SECCIÓN DE CONFIGURACIÓN --- *@
@* Se deshabilita o oculta cuando la partida inicia *@
<div style="margin-bottom: 20px; display: @(partidaEnCurso ? "none" : "block")">
    <h4>Configuración de Partida</h4>
    <label>Nombre Equipo 1:</label><br>
    <input @bind="nombreTmp1" placeholder="Nombre Equipo 1" /><br>

    <label>Nombre Equipo 2:</label><br>
    <input @bind="nombreTmp2" placeholder="Nombre Equipo 2" /><br />

    <label>Número de Rondas:</label><br>
    <input @bind="cantidadRondas" type="number" min="1" /><br><br>

    <button @onclick="ComenzarPartida" class="btn btn-primary">Comenzar Partida</button>
</div>

@* --- SECCIÓN DEL CONTENIDO DE LA PARTIDA --- *@
@if (partidaEnCurso)
{
    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 10px;">
        <div style="display: flex; justify-content: space-between;">
            <h4>Ronda Actual: @rondaActual / @cantidadRondas</h4>
            <button @onclick="FinalizarPartida" class="btn btn-danger">Finalizar Partida</button>
        </div>

        <hr />

        @if (string.IsNullOrEmpty(Juego.PreguntaActual))
        {
            <button @onclick="CargarPreguntaAleatoria" class="btn btn-primary btn-lg">Generar Pregunta</button>
        }
        else
        {
            <div style="background: #f0f0f0; padding: 15px; border-radius: 5px;">
                <h5><strong>Vista del Admin (La pregunta es):</strong></h5>
                <p>@Juego.PreguntaActual</p>
                
                @if (!Juego.PreguntaRevelada)
                {
                    <button @onclick="() => Juego.RevelarPregunta()" class="btn btn-warning">REVELAR PREGUNTA AL TABLERO</button>
                }
                else
                {
                    <span class="badge bg-success">Pregunta visible en tablero</span>
                }
            </div>

            <h4 style="margin-top:20px;">Respuestas (Presiona para revelar)</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                @foreach (var respuesta in Juego.RespuestasActuales)
                {
                    <button @onclick="() => Juego.RevelarRespuestaPorTexto(respuesta.res_respuesta)"
                            style="padding: 10px; background: @(Juego.RespuestasReveladas.Contains(respuesta.res_respuesta) ? "#4CAF50" : "#2196F3"); color: white; border: none; border-radius: 5px;">
                        @respuesta.res_respuesta (@respuesta.res_cantidad)
                    </button>
                }
            </div>

            <button @onclick="SiguienteRonda" style="margin-top: 20px;" class="btn btn-success">
                @(rondaActual < cantidadRondas ? "Siguiente Ronda" : "Finalizar")
            </button>
        }
    </div>
}

@code {
    private string nombreTmp1 = "";
    private string nombreTmp2 = "";
    private int cantidadRondas = 3; // Valor por defecto
    private int rondaActual = 0;
    private bool partidaEnCurso = false; // Controla la visibilidad
    private List<int> preguntasUsadas = new List<int>();

    protected override void OnInitialized()
    {
        Juego.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        Juego.OnChange -= StateHasChanged;
    }

    private void ComenzarPartida()
    {
        if (string.IsNullOrWhiteSpace(nombreTmp1) || string.IsNullOrWhiteSpace(nombreTmp2) || cantidadRondas <= 0)
        {
            // Podrías agregar una alerta aquí
            return;
        }

        Juego.ActualizarNombres(nombreTmp1, nombreTmp2);
        partidaEnCurso = true;
        rondaActual = 1;
        // Limpiar juego previo si existía
        Juego.LimpiarPregunta(); 
    }

    private void SiguienteRonda()
    {
        if (rondaActual < cantidadRondas)
        {
            rondaActual++;
            Juego.LimpiarPregunta(); // Asegúrate de tener este método en tu Servicio para resetear RespuestasActuales
        }
        else
        {
            // Lógica de fin de juego o mostrar ganador
            FinalizarPartida();
        }
    }

    private void FinalizarPartida()
    {
        partidaEnCurso = false;
        rondaActual = 0;
        preguntasUsadas.Clear();
        Juego.LimpiarPregunta();
        // Opcional: Resetear nombres
        nombreTmp1 = "";
        nombreTmp2 = "";
        Juego.ActualizarNombres(nombreTmp1, nombreTmp2);

    }

    private void CargarPreguntaAleatoria()
    {
        var preguntasDisponibles = DbContext.Preguntas
            .Where(p => !preguntasUsadas.Contains(p.pr_id))
            .ToList();

        if (!preguntasDisponibles.Any())
        {
            preguntasUsadas.Clear();
            preguntasDisponibles = DbContext.Preguntas.ToList();
        }

        if (preguntasDisponibles.Any())
        {
            var random = new Random();
            var preguntaAleatoria = preguntasDisponibles[random.Next(preguntasDisponibles.Count)];
            var respuestas = DbContext.Respuestas.Where(r => r.pr_id == preguntaAleatoria.pr_id).ToList();
            
            preguntasUsadas.Add(preguntaAleatoria.pr_id);
            Juego.ActualizarJuego(preguntaAleatoria.pr_pregunta, preguntaAleatoria.pr_id, respuestas);
        }
    }

    private async Task AbrirVentana() => await JSRuntime.InvokeVoidAsync("open", "/tablero", "_blank");
}